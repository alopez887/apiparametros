<!DOCTYPE html>  
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Parameters ‚Äì Activities by PAX</title>

  <!-- IBM Plex Sans / Mono -->
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

  <style>
    :root{
      --azul:#1d3b60;
      --azulClaro:#28518f;
      --bg:#f4f8fc;
      --radius:10px;
      --gap:20px;
      --ok:#1e8449;
      --err:#c0392b;
    }
    html,body{
      margin:0;
      height:100%;
      overflow:hidden;
      background:var(--bg);
      font-family:'IBM Plex Sans',system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;
      color:#000;
    }

    #wrapper{display:flex;height:100%}
    .hidden{display:none !important;}

    /* SIDEBAR */
    #sidebar{
      width:230px;
      min-width:230px;
      background:var(--azul);
      color:#fff;
      display:flex;
      flex-direction:column;
      padding:28px 18px 18px;
      box-sizing:border-box;
      position:relative;
      z-index:6;
    }
    #sidebar h2{font-size:22px;font-weight:600;margin:0 0 28px;line-height:1.2;}
    #menu button{
      width:100%;background:none;border:none;text-align:left;color:#fff;font-size:15px;
      padding:12px 10px;border-radius:6px;cursor:pointer;transition:background .25s;
    }
    #menu button:hover{background:rgba(255,255,255,.1)}
    #menu button.active{background:#fff;color:#000;pointer-events:none;}

    #btn-reportes,#btn-errores{
      width:100%;background:none;border:none;text-align:left;color:#fff;font-size:15px;
      padding:12px 10px;border-radius:6px;cursor:pointer;transition:background .25s;margin-top:12px;border-top:1px solid rgba(255,255,255,.18);
    }
    #btn-errores{border-top:none;margin-top:6px;}
    #btn-reportes:hover,#btn-errores:hover{background:rgba(255,255,255,.1)}
    .mail-error-count{font-weight:700;}

    /* CONTENT / TOPBAR */
    #content{flex:1;overflow:auto;display:flex;flex-direction:column;}
    #topbar{
      background:#fff;border-bottom:1px solid #d8e3f2;padding:14px 26px;
      display:flex;align-items:center;gap:16px;position:sticky;top:0;z-index:5;
    }
    #welcome-box{display:flex;align-items:center;gap:10px;font-size:18px;font-weight:600;color:#000;}
    #welcome-box i{font-size:22px;color:#000;}
    #date-badge{background:var(--azul);color:#fff;padding:4px 12px;border-radius:16px;font-size:14px;font-weight:600;margin-left:auto;}
    #logout{background:#c0392b;color:#fff;border:none;height:32px;padding:0 14px;border-radius:6px;font-size:14px;margin-left:10px;cursor:pointer;}

    .pan-wrapper{padding:30px;flex:1;overflow:auto;box-sizing:border-box;}
    .card{
      background:#fff;border:1px solid #d8e3f2;border-radius:var(--radius);
      padding:22px;margin-bottom:26px;box-shadow:0 2px 6px rgba(0,0,0,.05);
    }
    .card h3{margin:0 0 10px;font-size:18px;color:#000;display:flex;align-items:center;gap:10px;}
    .card p{font-size:14px;color:#000;margin:0 0 12px;}

    /* TABS */
    .acts-tabs-bar{display:flex;flex-wrap:wrap;gap:4px;margin-top:6px;padding:4px 0;border-bottom:1px solid #dde5f4;}
    .acts-tab{
      border:none;background:transparent;color:#3c4f6f;font-size:13px;padding:6px 14px;border-radius:999px;
      cursor:pointer;display:inline-flex;align-items:center;gap:6px;white-space:nowrap;
    }
    .acts-tab i{font-size:13px;}
    .acts-tab.active{background:var(--azulClaro);color:#fff;}
    .tab-description{margin-top:12px;font-size:13px;color:#4b5a78;}

    /* TOOLBAR */
    .toolbar{display:flex;flex-wrap:wrap;align-items:center;gap:10px;margin-top:16px;margin-bottom:10px;}
    .toolbar-left{display:flex;flex-wrap:wrap;align-items:center;gap:8px;flex:1;}
    .toolbar label{font-size:13px;font-weight:500;margin-right:4px;}
    .toolbar input[type="text"]{
      height:32px;padding:6px 10px;border-radius:6px;border:1px solid #cbdaf0;font-size:13px;
      font-family:'IBM Plex Sans',system-ui,sans-serif;min-width:180px;
    }
    .toolbar button{
      height:32px;border-radius:6px;border:none;font-size:13px;cursor:pointer;padding:0 12px;
      font-family:'IBM Plex Sans',system-ui,sans-serif;display:inline-flex;align-items:center;gap:6px;
    }
    .btn-secondary{background:#e1e7f3;color:#1b2a45;}
    .btn-primary{background:var(--azulClaro);color:#fff;}

    /* TABLA */
    .table-wrapper{margin-top:4px;border:1px solid #e0e7f3;border-radius:8px;overflow-x:auto;overflow-y:visible;max-height:none;}
    table.users-table{width:100%;border-collapse:collapse;font-size:13px;table-layout:fixed;}
    .users-table th,.users-table td{padding:7px 10px;text-align:left;border-bottom:1px solid #edf1f9;}
    .users-table th{background:#f5f7fc;font-weight:600;font-family:'IBM Plex Mono',monospace;}
    .users-table td{font-family:'IBM Plex Sans',system-ui,sans-serif;vertical-align:middle;}
    .users-table tr:last-child td{border-bottom:none;}

    .users-table th:nth-child(2), .users-table td:nth-child(2){ width:260px; }
    .users-table th:nth-child(10), .users-table td:nth-child(10){ width:190px; }

    .users-table td.actions{
      display:flex;flex-direction:column;align-items:flex-start;gap:8px;white-space:normal;
    }
    .actions .btn-group{display:flex;gap:6px;flex-wrap:nowrap;}

    .btn-row{
      border-radius:999px;border:1px solid #c0cbe4;background:#fff;font-size:11px;height:26px;padding:0 9px;
      cursor:pointer;display:inline-flex;align-items:center;gap:4px;white-space:nowrap;
    }
    .btn-row.primary{background:#28518f;border-color:#28518f;color:#fff;}
    .btn-row.primary.btn-toggle-inactive{background:#c0392b;border-color:#c0392b;color:#fff;}
    .row-highlight{background:#fff7d6 !important;}
    .users-table th,.users-table td{min-width:80px;}

    .subtle{color:#5b6a86;font-size:11px;display:inline-block;margin-top:2px;}

    /* PAGINACI√ìN */
    .pagination{display:flex;align-items:center;justify-content:center;gap:10px;margin-top:12px;font-size:12px;color:#52607a;}
    .pagination button{border-radius:6px;border:1px solid #c4d0ea;background:#fff;padding:2px 8px;font-size:11px;cursor:pointer;}
    .pagination button:disabled{opacity:.4;cursor:default;}

    /* MENU RESPONSIVE */
    .sidebar-oculto{display:none !important;}
    #btn-menu{background:none;color:#000;border:none;font-size:20px;cursor:pointer;padding:4px 8px;margin:0;}
    #backdrop{position:fixed;inset:0;background:rgba(0,0,0,.2);display:none;z-index:4;}
    #backdrop.show{display:block;}

    /* ===== POPUP (calcado de TIEMPO) ===== */
    #popup-msg{
      position:fixed;top:20px;left:50%;transform:translateX(-50%);
      width:min(520px, calc(100% - 32px));
      background:#fff;border-radius:10px;box-shadow:0 14px 40px rgba(0,0,0,.35);
      padding:12px 14px 10px;z-index:10050;border-left:4px solid var(--azulClaro);display:none;
    }
    #popup-msg[aria-hidden="false"]{display:block;}
    #popup-title{margin:0 0 4px;font-size:13px;font-weight:600;color:#0b2239;display:flex;align-items:center;gap:6px;flex-wrap:wrap;}
    #popup-body{margin:0 0 8px;font-size:13px;color:#273146;max-height:60vh;overflow:auto;}
    #popup-footer{display:flex;justify-content:flex-end;gap:8px;}
    #popup-close{border:none;border-radius:6px;background:#28518f;color:#fff;font-size:12px;padding:5px 14px;cursor:pointer;font-family:'IBM Plex Sans',system-ui,sans-serif;}
    #popup-edit{
      border:none;border-radius:6px;background:#e1e7f3;color:#1b2a45;font-size:12px;padding:5px 14px;cursor:pointer;
      font-family:'IBM Plex Sans',system-ui,sans-serif;display:none;
    }
    .details-grid{display:grid;grid-template-columns:180px 1fr;gap:8px 12px;align-items:start;}
    .details-grid .k{font-weight:600;color:#1d3b60;text-align:right;}
    .details-grid .v{word-break:break-word;}
    .popup-badge{
      background:#e8efff;color:#1d3b60;border:1px solid #cddaf7;font-size:11px;padding:2px 8px;border-radius:999px;margin-left:8px;font-weight:600;white-space:nowrap;
    }

    /* ===== MODAL ===== */
    #modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:40;display:none;}
    #modal-activity{
      position:fixed;top:40px;left:50%;transform:translateX(-50%);
      width:min(560px, calc(100% - 32px));background:#fff;border-radius:10px;
      box-shadow:0 14px 45px rgba(15,35,64,.3);padding:18px 20px 16px;z-index:41;display:none;font-size:14px;
    }
    #modal-activity[aria-hidden="false"]{display:block;}
    #modal-activity h4{margin:0 0 10px;font-size:16px;font-weight:600;color:#0b2239;}
    .modal-subtitle{margin:0 0 12px;font-size:13px;color:#5b6a86;}
    .modal-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px 12px;}
    .modal-row{}
    .modal-row.full{grid-column:1/-1;}
    .modal-row label{display:block;font-size:12px;font-weight:500;margin-bottom:3px;color:#26334f;}
    .modal-row input,.modal-row select{
      width:100%;height:32px;border-radius:6px;border:1px solid #cbdaf0;padding:6px 8px;font-size:13px;
      font-family:'IBM Plex Sans',system-ui,sans-serif;box-sizing:border-box;
    }
    .modal-footer{margin-top:14px;display:flex;justify-content:flex-end;gap:8px;}
    .modal-footer button{height:32px;border-radius:6px;border:none;padding:0 14px;font-size:13px;cursor:pointer;font-family:'IBM Plex Sans',system-ui,sans-serif;}
    #btn-act-cancel{ background:#e1e7f3;color:#1b2a45; }
    #btn-act-save{ background:var(--azulClaro);color:#fff; }

    /* ‚Äî‚Äî Bloque Grupo ‚Äî‚Äî */
    .grupo-box{
      display:flex;
      align-items:center;
      gap:24px;
      flex-wrap:wrap;
      margin-bottom:4px;
    }
    #row-grupo-title .grupo-box label{
      display:flex;
      align-items:center;
      gap:8px;
      font-size:13px;
      color:#26334f;
      margin:0;
    }
    /* Checkbox estilo cuadrito + palomita */
    #row-grupo-title .grupo-box input[type="checkbox"]{
      width:16px;
      height:16px;
      border:1px solid #b9c7e4;
      border-radius:4px;
      appearance:none;
      display:inline-block;
      position:relative;
      background:#fff;
      cursor:pointer;
      margin:0;
    }
    #row-grupo-title .grupo-box input[type="checkbox"]:checked::after{
      content:"";
      position:absolute;
      left:3px;
      top:0px;
      width:8px;
      height:12px;
      border:2px solid #28518f;
      border-top:none;
      border-left:none;
      transform:rotate(45deg);
    }
    .grupo-hint{
      font-size:12px;
      color:#5b6a86;
      margin-left:0;
      margin-top:4px;
    }
    .grupo-lock{
      display:none;
      align-items:center;
      gap:6px;
      background:#e8efff;
      color:#1d3b60;
      border:1px solid #cddaf7;
      border-radius:9999px;
      font-size:11px;
      padding:2px 8px;
      font-weight:600;
      margin-top:4px;
    }
    .grupo-lock.show{display:inline-flex;}
    .grupo-lock i{font-size:11px;}

    #row-select-grupo select{
      width:100%;height:32px;border-radius:6px;border:1px solid #cbdaf0;padding:6px 8px;
      font-size:13px;font-family:'IBM Plex Sans',system-ui,sans-serif;box-sizing:border-box;
    }

    @media (max-width:768px){
      #sidebar{ position:fixed; inset:0 auto 0 0; box-shadow:2px 0 10px rgba(0,0,0,.3); }
      .pan-wrapper{ padding:18px; }
      #popup-msg{ top:16px; }
      #modal-activity{ top:20px; }
      .details-grid{ grid-template-columns:1fr; }
      .details-grid .k{text-align:left;}
      .modal-grid{ grid-template-columns:1fr; }
      .users-table th:nth-child(10), .users-table td:nth-child(10){ width:200px; }
    }
  </style>
</head>
<body>
<div id="wrapper">
  <aside id="sidebar">
    <h2 id="sidebar-title">‚öôÔ∏è Parameters</h2>
    <div id="menu">
      <button data-sec="tc">Exchange rate</button>
      <button data-sec="usr-trn">Transport users</button>
      <button data-sec="usr-act">Activities users</button>
      <button data-sec="acts" class="active">Activities</button>
      <button data-sec="partners">Partners</button>
    </div>
    <button id="btn-reportes">Reports</button>
    <button id="btn-errores">üîï Sending errors</button>
  </aside>

  <div id="content">
    <div id="topbar">
      <div id="welcome-box">
        <button id="btn-menu" title="Show menu">‚ò∞</button>
        <i class="fas fa-user-circle"></i>
        <span id="welcome">Welcome!</span>
      </div>
      <span id="date-badge"></span>
      <button id="logout">Log out</button>
    </div>

    <div class="pan-wrapper">
      <section id="sec-pax" class="card">
        <h3 id="h3-title">üìù Activities by PAX (group)</h3>
        <p id="p-intro">From here you can manage the activities catalog and its different price modes.</p>

        <!-- Tabs -->
        <div class="acts-tabs-bar" id="acts-tabs-bar">
          <button class="acts-tab" data-tab="tours"><i class="fas fa-users"></i><span id="tab-tours-label">Adultos / Ni√±os / Persona</span></button>
          <button class="acts-tab" data-tab="tiempo"><i class="fas fa-clock"></i><span id="tab-tiempo-label">Actividades por duraci√≥n (tiempo)</span></button>
          <button class="acts-tab active" data-tab="pax"><i class="fas fa-user-friends"></i><span id="tab-pax-label">Actividades por PAX (grupo)</span></button>
          <button class="acts-tab" data-tab="combo"><i class="fas fa-layer-group"></i><span id="tab-combo-label">Combos de actividades</span></button>
        </div>

        <div class="tab-description" id="tab-description">Aqu√≠ administrar√°s actividades con precio por grupo (PAX).</div>

        <!-- Toolbar -->
        <div class="toolbar" id="toolbar-pax">
          <div class="toolbar-left">
            <label id="lbl-search-pax" for="txt-search-pax">Search:</label>
            <input type="text" id="txt-search-pax" placeholder="Type a code, activity or supplier‚Ä¶">
            <button class="btn-secondary" id="btn-search-pax"><i class="fas fa-search"></i><span id="lbl-btn-search-pax">Search</span></button>
            <button class="btn-secondary" id="btn-clear-search-pax"><i class="fas fa-times"></i><span id="lbl-btn-clear-pax">Clear</span></button>
          </div>
          <button class="btn-primary" id="btn-add-pax"><i class="fas fa-plus"></i><span id="lbl-btn-add-pax">Add activity</span></button>
        </div>

        <!-- Tabla -->
        <div class="table-wrapper">
          <table class="users-table" id="tbl-pax">
            <thead>
              <tr>
                <th id="th-code-pax">Code</th>
                <th id="th-activity-pax">Activity</th>
                <th id="th-capacity-pax">Capacity</th>
                <th id="th-price-pax">Price</th>
                <th id="th-currency-pax">Currency</th>
                <th id="th-supplier-pax">Supplier</th>
                <th id="th-status-pax">Status</th>
                <th id="th-created-pax">Created</th>
                <th id="th-updated-pax">Updated</th>
                <th id="th-actions-pax">Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="pagination" id="pagination-pax"></div>
      </section>
    </div>
  </div>
</div>

<div id="backdrop"></div>

<!-- POPUP (copiado 1:1 de Tiempo) -->
<div id="popup-msg" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="popup-title-text">
  <p id="popup-title"><i class="fas fa-circle-info"></i><span id="popup-title-text">Details</span></p>
  <div id="popup-body">‚Ä¶</div>
  <div id="popup-footer">
    <button id="popup-edit" style="display:none"><span id="popup-edit-text">Edit</span></button>
    <button id="popup-close"><span id="popup-close-text">OK</span></button>
  </div>
</div>

<!-- MODAL -->
<div id="modal-overlay" aria-hidden="true"></div>
<div id="modal-activity" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="modal-act-title">
  <h4 id="modal-act-title">Edit activity</h4>
  <p class="modal-subtitle" id="modal-act-sub">Update the fields below. ID is not editable.</p>

  <div class="modal-grid">
    <!-- C√≥digo / Moneda -->
    <div class="modal-row"><label for="ma-codigo" id="lbl-ma-codigo">Code</label><input type="text" id="ma-codigo"></div>
    <div class="modal-row">
      <label for="ma-moneda" id="lbl-ma-moneda">Currency</label>
      <select id="ma-moneda" disabled><option value="USD">USD</option></select>
    </div>

    <!-- Actividad -->
    <div class="modal-row full"><label for="ma-nombre" id="lbl-ma-nombre">Activity</label><input type="text" id="ma-nombre"></div>

    <!-- Duraci√≥n (ES/EN) -->
    <div class="modal-row"><label for="ma-dur-es" id="lbl-ma-dur-es">Duration (ES)</label><input type="text" id="ma-dur-es"></div>
    <div class="modal-row"><label for="ma-dur-en" id="lbl-ma-dur-en">Duration (EN)</label><input type="text" id="ma-dur-en"></div>

    <!-- Capacidad (ES/EN como TEXTO) -->
    <div class="modal-row"><label for="ma-cap-es" id="lbl-ma-cap-es">Capacity (ES)</label><input type="text" id="ma-cap-es"></div>
    <div class="modal-row"><label for="ma-capacidad" id="lbl-ma-capacidad">Capacity</label><input type="text" id="ma-capacidad"></div>

    <!-- Precios -->
    <div class="modal-row"><label for="ma-precio" id="lbl-ma-precio">Price</label><input type="number" step="0.01" id="ma-precio"></div>
    <div class="modal-row"><label for="ma-precio-normal" id="lbl-ma-precio-normal">Regular Price</label><input type="number" step="0.01" id="ma-precio-normal"></div>
    <div class="modal-row"><label for="ma-precio-opc" id="lbl-ma-precio-opc">OPC Price</label><input type="number" step="0.01" id="ma-precio-opc"></div>

    <!-- ===== GRUPO ===== -->
    <div class="modal-row full" id="row-grupo-title" style="display:none;">
      <label id="lbl-grupo-title" style="margin-bottom:6px;">Group</label>
      <div class="grupo-box" role="group" aria-label="Group options">
        <label>
          <input class="chkbox" type="checkbox" id="chk-grupo-existente">
          <span id="lbl-grupo-existente">Add to existing group</span>
        </label>
        <label>
          <input class="chkbox" type="checkbox" id="chk-grupo-nuevo">
          <span id="lbl-grupo-nuevo">Create new group</span>
        </label>
      </div>
      <div class="grupo-hint" id="hint-grupo">Choose one option</div>
      <div class="grupo-lock" id="hint-lock">
        <i class="fas fa-lock"></i>
        <span id="hint-lock-text">Locked to last created group</span>
      </div>
    </div>

    <div class="modal-row full" id="row-select-grupo" style="display:none;">
      <label for="ma-grupo-select" id="lbl-ma-grupo">Select group</label>
      <select id="ma-grupo-select"></select>
    </div>
    <!-- ===== FIN GRUPO ===== -->

    <!-- Proveedor -->
    <div class="modal-row full"><label for="ma-proveedor" id="lbl-ma-proveedor">Supplier</label><select id="ma-proveedor"></select></div>
  </div>

  <div class="modal-footer">
    <button id="btn-act-cancel"><span id="lbl-btn-act-cancel">Cancel</span></button>
    <button id="btn-act-save"><span id="lbl-btn-act-save">Save</span></button>
  </div>
</div>

<script>
  const API_BASE = 'https://apiparametros-production.up.railway.app';
  const $id = id => document.getElementById(id);

  /* ===== I18N ===== */
  const I18N = {
    es:{
      sidebar_title:"‚öôÔ∏è Par√°metros", m_tc:"Tipo de cambio", m_usr_trn:"Usuarios transporte", m_usr_act:"Usuarios actividades",
      m_acts:"Actividades", m_partners:"Partners", m_reports:"Reportes", m_errors:"üîï Errores de env√≠o",
      welcome:(n)=> n?`¬°Bienvenido ${n}!`:"¬°Bienvenido!", logout:"Cerrar sesi√≥n",
      date_badge:(d)=> new Intl.DateTimeFormat('es-MX',{dateStyle:'full'}).format(d),

      title:"üìù Cat√°logo de actividades", intro:"Desde aqu√≠ podr√°s administrar el cat√°logo de actividades y sus diferentes esquemas de precio.",
      tab_tours:"Adultos / Ni√±os / Persona", tab_tiempo:"Actividades por duraci√≥n (tiempo)", tab_pax:"Actividades por PAX (grupo)", tab_combo:"Combos de actividades",
      desc_tours:"Aqu√≠ administrar√°s las actividades cuyo precio est√° definido por Adultos / Ni√±os / Persona.",
      desc_tiempo:"Aqu√≠ administrar√°s actividades cuyo precio depende de la duraci√≥n (por ejemplo, por hora o por bloque de tiempo).",
      desc_pax:"Aqu√≠ administrar√°s actividades con precio por grupo (PAX).",
      desc_combo:"Aqu√≠ administrar√°s los combos que agrupan varias actividades en un solo paquete.",

      pax_search_label:"Buscar:", pax_search_ph:"Escribe un c√≥digo, actividad o proveedor‚Ä¶",
      pax_btn_search:"Buscar", pax_btn_clear:"Limpiar", pax_btn_add:"Agregar actividad",

      pax_th_code:"C√≥digo", pax_th_activity:"Actividad", pax_th_capacity:"Capacidad", pax_th_price:"Precio",
      pax_th_currency:"Moneda", pax_th_supplier:"Proveedor", pax_th_status:"Estatus",
      pax_th_created:"Creado", pax_th_updated:"Actualizado", pax_th_actions:"Acciones",

      popup_title_details:"Detalles", popup_btn_edit:"Modificar", popup_btn_ok:"Aceptar",
      popup_badge_pax:"Actividad: Por PAX",

      modal_title_edit:"Editar actividad PAX", modal_title_new:"Agregar actividad PAX", modal_subtitle:"Completa los campos para crear una nueva actividad.",
      ma_code:"C√≥digo", ma_currency:"Moneda", ma_activity:"Actividad",
      ma_capacity:"Capacidad", ma_price:"Precio", ma_price_reg:"Precio Normal", ma_price_opc:"Precio OPC", ma_supplier:"Proveedor",

      btn_cancel:"Cancelar", btn_save:"Guardar",
      group_label:"Grupo",
      grp_add_existing:"Agregar a grupo existente",
      grp_create_new:"Crear nuevo grupo",
      grp_select_label:"Selecciona el grupo",
      grp_choose_one:"Elige una opci√≥n. Si agregas a un grupo existente, selecciona el grupo abajo.",
      grp_must_select:"Debes seleccionar un grupo existente.",
      grp_locked:"Bloqueado al √∫ltimo grupo creado",

      dur_es_label:"Duraci√≥n (Espa√±ol)",
      dur_en_label:"Duraci√≥n (Ingl√©s)",
      cap_es_label:"Capacidad (Espa√±ol)",
      cap_en_label:"Capacidad (Ingl√©s)",
      created_label:"Creado",
      updated_label:"Actualizado",

      no_records:"No se encontraron actividades.",
      pag_prev:"Anterior", pag_next:"Siguiente", pag_page_of:(p,t)=>`P√°gina ${p} de ${t}`,
      act_details:"Ver detalle", act_edit:"Modificar", act_activate:"Crear", act_deactivate:"Desactivar",
      toggle_on_ok:"Actividad activada.", toggle_off_ok:"Actividad desactivada.", toggle_err:"No se pudo cambiar el estatus.",
      saved_ok:"Actividad guardada correctamente.", created_ok:"Actividad creada correctamente.", save_err:"Error al guardar la actividad.",
      /* MENSAJES DE VALIDACI√ìN base */
      code_exists:"El c√≥digo que intentas registrar ya existe. Usa otro c√≥digo o edita la actividad existente.",
      duration_exists:"Ya existe una actividad PAX con la misma duraci√≥n para ese grupo.",
      code_and_duration_exists:"El c√≥digo y la duraci√≥n que intentas registrar ya existen en otra actividad PAX.",
      save_err_validation:"No se pudo guardar la actividad porque hay datos duplicados.",

      /* NUEVO: popup exacto como TIEMPO (sin chapita) */
      err_title:"Error",
      err_code_in:(m)=>`Error: El c√≥digo que intentas registrar ya existe en: ${m}.`,
      err_duration_in:(m)=>`Error: La duraci√≥n que intentas registrar ya existe en: ${m}.`
    },
    en:{
      sidebar_title:"‚öôÔ∏è Parameters", m_tc:"Exchange rate", m_usr_trn:"Transport users", m_usr_act:"Activities users",
      m_acts:"Activities", m_partners:"Partners", m_reports:"Reports", m_errors:"üîï Sending errors",
      welcome:(n)=> n?`Welcome ${n}!`:"Welcome!", logout:"Log out",
      date_badge:(d)=> new Intl.DateTimeFormat('en-US',{dateStyle:'full'}).format(d),

      title:"üìù Activities catalog", intro:"From here you can manage the activities catalog and its different price modes.",
      tab_tours:"Adults / Children / Per person", tab_tiempo:"Activities by duration (time)", tab_pax:"Activities by PAX (group)", tab_combo:"Activity combos",
      desc_tours:"Manage activities whose price is defined by Adults / Children / Per person.",
      desc_tiempo:"Manage activities whose price depends on duration (for example per hour or time block).",
      desc_pax:"Manage activities with price per group (PAX).",
      desc_combo:"Manage combos that group several activities into a single package.",

      pax_search_label:"Search:", pax_search_ph:"Type a code, activity or supplier‚Ä¶",
      pax_btn_search:"Search", pax_btn_clear:"Clear", pax_btn_add:"Add activity",

      pax_th_code:"Code", pax_th_activity:"Activity", pax_th_capacity:"Capacity", pax_th_price:"Price",
      pax_th_currency:"Currency", pax_th_supplier:"Supplier", pax_th_status:"Status",
      pax_th_created:"Created", pax_th_updated:"Updated", pax_th_actions:"Actions",

      popup_title_details:"Details", popup_btn_edit:"Edit", popup_btn_ok:"OK",
      popup_badge_pax:"Activity: Per PAX",

      modal_title_edit:"Edit PAX activity", modal_title_new:"Add PAX activity", modal_subtitle:"Fill the fields to create a new activity.",
      ma_code:"Code", ma_currency:"Currency", ma_activity:"Activity",
      ma_capacity:"Capacity", ma_price:"Regular Price", ma_price_reg:"Regular Price", ma_price_opc:"OPC Price", ma_supplier:"Supplier",

      btn_cancel:"Cancel", btn_save:"Save",
      group_label:"Group",
      grp_add_existing:"Add to existing group",
      grp_create_new:"Create new group",
      grp_select_label:"Select group",
      grp_choose_one:"Choose one option. If you add to an existing group, select the group below.",
      grp_must_select:"You must select an existing group.",
      grp_locked:"Locked to last created group",

      dur_es_label:"Duration (Spanish)",
      dur_en_label:"Duration (English)",
      cap_es_label:"Capacity (Spanish)",
      cap_en_label:"Capacity (English)",
      created_label:"Created",
      updated_label:"Updated",

      no_records:"No activities found.",
      pag_prev:"Prev", pag_next:"Next", pag_page_of:(p,t)=>`Page ${p} of ${t}`,
      act_details:"Details", act_edit:"Edit", act_activate:"Activate", act_deactivate:"Deactivate",
      toggle_on_ok:"Activity activated.", toggle_off_ok:"Activity deactivated.", toggle_err:"Status change failed.",
      saved_ok:"Activity saved successfully.", created_ok:"Activity created successfully.", save_err:"Error saving activity.",
      code_exists:"The code you are trying to register already exists. Use another code or edit the existing activity.",
      duration_exists:"There is already a PAX activity with the same duration for that group.",
      code_and_duration_exists:"Both the code and the duration you are trying to register already exist in another PAX activity.",
      save_err_validation:"The activity could not be saved because there are duplicated values.",

      err_title:"Error",
      err_code_in:(m)=>`Error: The code you are trying to register already exists in: ${m}.`,
      err_duration_in:(m)=>`Error: The duration you are trying to register already exists in: ${m}.`
    }
  };

  // Idioma por defecto EN
  let __LANG='en', currentName='', __MAIL_ERRORS=0;

  const mapLang = v => String(v||'en').toLowerCase().startsWith('es') ? 'es' : 'en';
  function T(key, ...args){ const pack=I18N[__LANG]||I18N.en; const val=pack[key]; if (typeof val==='function') return val(...args); const fb=I18N.en[key]; return (val!=null)?val:(fb!=null?fb:key); }
  function setWelcome(name){ if (name) currentName=name; const el=$id('welcome'); if (el) el.textContent=T('welcome', currentName||''); }
  function updateErrorsButtonLabel(){
    const btnErr=$id('btn-errores'); if (!btnErr) return;
    const base=T('m_errors'); const n=Number(__MAIL_ERRORS)||0;
    if (n<=0) btnErr.textContent=base; else btnErr.innerHTML=`${base} (<span class="mail-error-count">${n}</span>)`;
  }

  /* ======= Nombres de m√≥dulos para el mensaje ======= */
  const MODULE_NAMES = {
    es: {
      tours:  "Adultos / Ni√±os / Persona",
      tiempo: "Actividades por duraci√≥n (tiempo)",
      pax:    "Actividades por PAX (grupo)",
      combo:  "Combos de actividades"
    },
    en: {
      tours:  "Adults / Children / Per person",
      tiempo: "Activities by duration (time)",
      pax:    "Activities by PAX (group)",
      combo:  "Activity combos"
    }
  };
  function moduleLabelForLang(key){
    const pack = MODULE_NAMES[__LANG] || MODULE_NAMES.en;
    return key && pack[key] ? pack[key] : pack.tours;
  }
  function resolveModuleKeyFromServer(j){
    const candidates = [
      j?.exists_in, j?.module, j?.where, j?.origen, j?.table,
      Array.isArray(j?.tables)  ? j.tables[0]  : null,
      Array.isArray(j?.modules) ? j.modules[0] : null,
      Array.isArray(j?.in)      ? j.in[0]      : null
    ].filter(Boolean);
    const raw = String(candidates[0]||'').toLowerCase();
    if (/(tour[_-]?pax|pax)/.test(raw)) return 'pax';
    if (/(duracion|tiempo|tour[_-]?duracion)/.test(raw)) return 'tiempo';
    if (/(combo|tours?[_-]?combo)/.test(raw)) return 'combo';
    if (/(tours?|adult|ni√±|child|persona)/.test(raw)) return 'tours';
    if (raw==='pax') return 'pax';
    return null;
  }

  /* ===== NUEVO =====
     Construir lista de nombres de cat√°logos desde el 409 del back (para popup exacto) */
  function buildCatalogNamesFrom409(j){
    const raw =
      (Array.isArray(j?.catalogs)       && j.catalogs) ||
      (Array.isArray(j?.data?.catalogs) && j.data.catalogs) ||
      (Array.isArray(j?.in)             && j.in) ||
      (Array.isArray(j?.modules)        && j.modules) ||
      [];

    const labels = raw.map(it=>{
      if (typeof it === 'string') return it;
      if (it && typeof it === 'object'){
        if (__LANG === 'es') return it.label_es || it.etiqueta_es || it.nombre_es || it.name_es || it.label || it.name;
        return it.label_en || it.etiqueta_en || it.nombre_en || it.name_en || it.label || it.name;
      }
      return '';
    }).filter(Boolean);

    const uniq = [...new Set(labels)];
    return uniq.length ? uniq.join(', ') : null;
  }

  /* ===== Helpers ===== */
  function pad2(n){ return n<10?('0'+n):(''+n); }
  function formatDateTime(val){
    if (!val) return '';
    const d=new Date(val); if (Number.isNaN(d.getTime())) return '';
    const day=pad2(d.getDate()), month=pad2(d.getMonth()+1), year=d.getFullYear();
    const h24=d.getHours(); let h12=h24%12; if (h12===0) h12=12; const mins=pad2(d.getMinutes()); const suf=h24<12?(__LANG==='es'?'a. m.':'AM'):(__LANG==='es'?'p. m.':'PM');
    return `${day}/${month}/${year}, ${pad2(h12)}:${mins} ${suf}`;
  }
  function money(val){ if (val===null||val===undefined||val==='') return ''; const num=Number(String(val).replace(/[^0-9.\-]/g,'')); if (!Number.isFinite(num)) return String(val); const locale=(__LANG==='es')?'es-MX':'en-US'; try{ return new Intl.NumberFormat(locale,{style:'currency',currency:'USD'}).format(num);}catch(_){ return num.toFixed(2);} }
  function numOrNull(v){ if (v===''||v==null||v===undefined) return null; const n=Number(String(v).replace(/[^0-9.\-]/g,'')); return Number.isFinite(n)?n:null; }
  function textOrNull(v){ if (v===undefined||v===null) return null; const s=String(v).trim(); return s===''?null:s; }

  /* ===== POPUP (ajustado: permite quitar badge y poner t√≠tulo custom) ===== */
  const popupBox=$id('popup-msg'), popupTitleP=$id('popup-title'), popupTitleText=$id('popup-title-text'), popupBody=$id('popup-body'), popupClose=$id('popup-close'), popupEdit=$id('popup-edit');

  function setPopupTitle(mainText, { showBadge=true, badgeText } = {}){
    if (!popupTitleP) return;
    if (showBadge){
      popupTitleP.innerHTML =
        `<i class="fas fa-circle-info"></i><span id="popup-title-text">${mainText||T('popup_title_details')}</span><span class="popup-badge">${badgeText||T('popup_badge_pax')}</span>`;
    }else{
      popupTitleP.innerHTML =
        `<i class="fas fa-circle-info"></i><span id="popup-title-text">${mainText||T('popup_title_details')}</span>`;
    }
  }

  function showPopupHTML(titleText, html, opts={}){
    setPopupTitle(titleText, opts);
    if (popupBody) popupBody.innerHTML=html||'';
    if (popupEdit){ popupEdit.style.display='none'; popupEdit.removeAttribute('data-id'); }
    popupBox.setAttribute('aria-hidden','false');
    try{ window.parent.postMessage({ type:'CTS_SCROLL_IFRAME_PARAM' }, '*'); }catch(_){}
  }
  function showPopupText(message, opts={}){
    setPopupTitle(opts?.title || T('popup_title_details'), { showBadge: opts?.badge!==false, badgeText: opts?.badgeText||T('popup_badge_pax') });
    popupBody.textContent=message||'';
    if (popupEdit){ popupEdit.style.display='none'; popupEdit.removeAttribute('data-id'); }
    popupBox.setAttribute('aria-hidden','false');
    try{ window.parent.postMessage({ type:'CTS_SCROLL_IFRAME_PARAM' }, '*'); }catch(_){}
  }
  function hidePopup(){ if (popupBox) popupBox.setAttribute('aria-hidden','true'); }
  if (popupClose) popupClose.addEventListener('click', hidePopup);

  function statusText(row){
    if (row.estatus!=null){ const v=(''+row.estatus).toLowerCase();
      if (['1','true','activo','active'].includes(v)) return (__LANG==='es'?'Activo':'Active');
      if (['0','false','inactivo','inactive'].includes(v)) return (__LANG==='es'?'Inactivo':'Inactive');
      return row.estatus;
    }
    if (row.activo!=null){ return row.activo ? (__LANG==='es'?'Activo':'Active') : (__LANG==='es'?'Inactivo':'Inactive'); }
    return '-';
  }
  function isRowActive(row){
    if (row.estatus!=null){ const v=String(row.estatus).toLowerCase(); return ['1','true','activo','active'].includes(v); }
    if (row.activo!=null){ return !!row.activo; }
    return false;
  }
  function getGrupo(row){
    return row?.actividad_id ?? row?.grupo ?? row?.group_id ?? row?.id_grupo ?? row?.actividadid ?? null;
  }

  /* ‚Äî‚Äî POPUP DETALLES ‚Äî‚Äî */
  function buildDetailsHTML(row){
    const rows = [];
    const add = (label, value) => {
      const v = (value === 0 || value === false)
        ? String(value)
        : (value == null || String(value).trim() === '' ? null : value);
      if (v == null) return;
      rows.push([label, v]);
    };

    add(T('pax_th_code'), row.codigo);
    add(T('pax_th_activity'), row.actividad);

    // Duraci√≥n / Capacidad (ES/EN)
    add(T('dur_es_label'), row.duracion_es);
    add(T('dur_en_label'), row.duracion);
    add(T('cap_es_label'), row.capacidad_es);
    add(T('cap_en_label'), row.capacidad);

    // Precios
    add(T('pax_th_price'), (row.precio!=null && row.precio!=='') ? money(row.precio) : null);
    add(T('ma_price_reg'), (row.precio_normal!=null && row.precio_normal!=='') ? money(row.precio_normal) : null);
    add(T('ma_price_opc'), (row.precioopc!=null && row.precioopc!=='') ? money(row.precioopc) : null);

    // Moneda / Proveedor
    add(T('pax_th_currency'), (row.moneda||'USD').toUpperCase());
    add(T('pax_th_supplier'), row.proveedor ?? row.partner);

    // Grupo (si existe)
    const grp = getGrupo(row);
    if (grp!=null) add(`${T('group_label')}`, grp);

    // Estatus + Fechas
    add(T('pax_th_status'), statusText(row));
    add(T('created_label'),  formatDateTime(row.created_at || row.created));
    add(T('updated_label'),  formatDateTime(row.updated_at || row.updated || row.modified_at));

    return '<div class="details-grid">' +
      rows.map(([k,v]) => `<div class="k">${k}</div><div class="v">${v}</div>`).join('') +
      '</div>';
  }

  function showDetailsPopup(row){
    const html = buildDetailsHTML(row);
    showPopupHTML(T('popup_title_details'), html, { showBadge:true });
    if (popupEdit){
      popupEdit.style.display='inline-flex';
      popupEdit.textContent = T('popup_btn_edit');
      popupEdit.dataset.id = row.id;
    }
  }
  if (popupEdit){
    popupEdit.addEventListener('click', ()=>{
      const id = popupEdit.dataset.id;
      hidePopup();
      const row = paxData.find(a => String(a.id)===String(id));
      if (row) openPaxModal(row);
    });
  }

  /* ===== NAV / TABS ===== */
  const TAB_CONFIG={tours:{iframe:'iframeTours',descKey:'desc_tours'}, tiempo:{iframe:'iframeTiempo',descKey:'desc_tiempo'}, pax:{iframe:'iframePax',descKey:'desc_pax'}, combo:{iframe:'iframeCombo',descKey:'desc_combo'}};
  let currentPage=1; let currentTab='pax';

  function updateTabDescription(tabId){ const cfg=TAB_CONFIG[tabId]; const el=$id('tab-description'); if (!cfg||!el) return; el.textContent=T(cfg.descKey); }
  function setActiveTab(tabId,fromParent=false){
    if (!TAB_CONFIG[tabId]) return; currentTab=tabId;
    document.querySelectorAll('.acts-tab').forEach(btn=>btn.classList.toggle('active', btn.dataset.tab===tabId));
    updateTabDescription(tabId);
    if (!fromParent){ const cfg=TAB_CONFIG[tabId]; try{ window.parent.postMessage({ type:'ACTIVIDADES_IFRAME_NAV', iframe: cfg.iframe }, '*'); }catch(_){} }
  }
  document.addEventListener('click',(e)=>{ const btn=e.target.closest('.acts-tab'); if (!btn) return; const tabId=btn.dataset.tab; if (!tabId) return; setActiveTab(tabId,false); });

  /* ===== MENU/BACKDROP ===== */
  const sidebar=$id('sidebar'), btnMenu=$id('btn-menu'), backdrop=$id('backdrop');
  function openMenu(){ sidebar.classList.remove('sidebar-oculto'); btnMenu.style.display='none'; backdrop.classList.add('show'); }
  function closeMenu(){ sidebar.classList.add('sidebar-oculto'); btnMenu.style.display='block'; backdrop.classList.remove('show'); }
  btnMenu.addEventListener('click', openMenu);
  backdrop.addEventListener('click', closeMenu);
  document.addEventListener('keydown',(e)=>{ 
    if (e.key==='Escape'){
      if (popupBox && popupBox.getAttribute('aria-hidden')==='false'){ hidePopup(); return; }
      if (modalActBox.getAttribute('aria-hidden')==='false'){ closePaxModal(); return; }
      if (!sidebar.classList.contains('sidebar-oculto')) closeMenu();
    }
  });
  document.querySelectorAll('#menu button').forEach(btn=>{ btn.onclick=()=>{ const sec=btn.dataset.sec; closeMenu(); if (sec==='acts') return; try{ window.parent.postMessage({ type:'PARAMS_NAV', section: sec }, '*'); }catch(_){} }; });
  const btnRep2=$id('btn-reportes'); if (btnRep2){ btnRep2.addEventListener('click',()=>{ try{ window.parent.postMessage({ type:'GO_REPORTES' }, '*'); }catch(_){} }); }
  const btnErr2=$id('btn-errores'); if (btnErr2){ btnErr2.addEventListener('click',()=>{ try{ window.parent.postMessage({ type:'GO_MAIL_ERRORS' }, '*'); }catch(_){} }); }
  $id('logout').onclick=()=>{ try{ window.parent.postMessage({ action:'logout' }, '*'); }catch(_){} };

  /* ===== TABLA PAX ===== */
  const tblPaxBody = document.querySelector('#tbl-pax tbody');
  const paginationPax = $id('pagination-pax');
  const txtSearchPax = $id('txt-search-pax');
  const btnSearchPax = $id('btn-search-pax');
  const btnClearSearchPax = $id('btn-clear-search-pax');
  const PAGE_SIZE=10; let paxData=[]; let currentSearch=''; let highlightId=null;

  function getFiltered(){
    const term=currentSearch.trim().toLowerCase();
    if (!term) return paxData.slice();
    return paxData.filter(r=>{
      const f = [
        r.codigo, r.actividad, r.capacidad, r.precio, r.moneda, r.proveedor, r.partner,
        getGrupo(r)
      ];
      return f.some(v => v!=null && String(v).toLowerCase().includes(term));
    });
  }

  function renderPaxTable(){
    if (!tblPaxBody) return;
    const all = getFiltered();
    if (all.length===0){
      tblPaxBody.innerHTML = `<tr><td colspan="10" style="padding:10px 12px;color:#65708c;font-size:13px;">${T('no_records')}</td></tr>`;
      renderPaxPagination(1);
      return;
    }
    const totalPages = Math.max(1, Math.ceil(all.length/PAGE_SIZE));
    if (currentPage>totalPages) currentPage=totalPages;
    const start=(currentPage-1)*PAGE_SIZE;
    const pageRows=all.slice(start, start+PAGE_SIZE);

    const rowsHtml = pageRows.map(row=>{
      const code=row.codigo||'';
      const name=row.actividad||'';
      const grp = getGrupo(row);
      const nameCell = grp ? `${name}<br><small class="subtle">${T('group_label')}: ${grp}</small>` : `${name}`;

      const cap=row.capacidad??'';
      const price = row.precio!=null && row.precio!=='' ? money(row.precio) : '';
      const cur=(row.moneda||'USD').toUpperCase();
      const prov=row.proveedor||row.partner||'';
      const created=formatDateTime(row.created_at||row.created);
      const updated=formatDateTime(row.updated_at||row.updated||row.modified_at);
      const est=statusText(row);
      const rowClass=(highlightId!=null && String(highlightId)===String(row.id)) ? 'row-highlight' : '';
      const inactive = !isRowActive(row);
      const toggleClass= inactive ? 'btn-toggle-inactive' : 'btn-toggle-active';
      const toggleIcon = inactive ? 'fa-toggle-off' : 'fa-toggle-on';
      const toggleText = inactive ? T('act_activate') : T('act_deactivate');

      return `
        <tr data-id="${row.id}" class="${rowClass}">
          <td style="font-family:'IBM Plex Mono',monospace;">${code}</td>
          <td>${nameCell}</td>
          <td>${cap}</td>
          <td>${price}</td>
          <td>${cur}</td>
          <td>${prov}</td>
          <td>${est}</td>
          <td>${created}</td>
          <td>${updated}</td>
          <td class="actions">
            <div class="btn-group">
              <button class="btn-row" data-act="details" data-id="${row.id}"><i class="fas fa-eye"></i><span>${T('act_details')}</span></button>
              <button class="btn-row" data-act="edit" data-id="${row.id}"><i class="fas fa-pen"></i><span>${T('act_edit')}</span></button>
            </div>
            <button class="btn-row primary ${toggleClass}" data-act="toggle" data-id="${row.id}">
              <i class="fas ${toggleIcon}"></i><span>${toggleText}</span>
            </button>
          </td>
        </tr>
      `;
    }).join('');
    tblPaxBody.innerHTML = rowsHtml;

    if (highlightId!=null){
      setTimeout(()=>{ const tr=document.querySelector('#tbl-pax tr.row-highlight'); if (tr) tr.classList.remove('row-highlight'); highlightId=null; }, 2200);
    }

    renderPaxPagination(totalPages);
  }

  function renderPaxPagination(totalPages){
    const pag = paginationPax; if (pag) pag.innerHTML='';
    if (!pag || totalPages<=1) return;

    const prevBtn=document.createElement('button'); prevBtn.textContent=T('pag_prev'); prevBtn.disabled=currentPage===1;
    prevBtn.onclick=()=>{ if (currentPage>1){ currentPage--; const card=$id('sec-pax'); if (card&&card.scrollIntoView){ card.scrollIntoView({behavior:'smooth',block:'start'});} renderPaxTable(); } };
    const nextBtn=document.createElement('button'); nextBtn.textContent=T('pag_next'); nextBtn.disabled=currentPage===totalPages;
    nextBtn.onclick=()=>{ if (currentPage<totalPages){ currentPage++; const card=$id('sec-pax'); if (card&&card.scrollIntoView){ card.scrollIntoView({behavior:'smooth',block:'start'});} renderPaxTable(); } };
    const label=document.createElement('span'); label.textContent=T('pag_page_of', currentPage, totalPages);
    pag.appendChild(prevBtn); pag.appendChild(label); pag.appendChild(nextBtn);
  }

  function applyFilterAndRender(){
    currentPage = 1;
    renderPaxTable();
    const card=$id('sec-pax'); if (card&&card.scrollIntoView){ card.scrollIntoView({behavior:'smooth',block:'start'}); }
  }

  const tblPax=$id('tbl-pax');
  if (tblPax){
    tblPax.addEventListener('click', e=>{
      const btn=e.target.closest('button[data-act]'); if (!btn) return;
      const act=btn.dataset.act; const id=btn.dataset.id;
      const row = paxData.find(a=> String(a.id)===String(id));
      if (!row && act!=='toggle') return;

      if (act==='details'){ showDetailsPopup(row); return; }
      if (act==='edit'){ openPaxModal(row); return; }
      if (act==='toggle'){ if (!row) return; const nowActive=isRowActive(row); togglePax(row.id, !nowActive, btn); return; }
    });
  }

  /* ===== DATA ===== */
  async function loadPax(){
    if (tblPaxBody){ tblPaxBody.innerHTML=`<tr><td colspan="10" style="padding:10px 12px;color:#65708c;font-size:13px;">Loading‚Ä¶</td></tr>`; }
    if (paginationPax) paginationPax.innerHTML='';
    try{
      const res=await fetch(`${API_BASE}/api/actividades-pax/listar-actividades`);
      if (!res.ok) throw new Error('HTTP '+res.status);
      const j=await res.json();
      paxData = Array.isArray(j.data) ? j.data : [];
      renderPaxTable();
    }catch(err){
      console.error('‚ùå [PAX] load:', err);
      paxData = [];
      renderPaxTable();
    }
  }

  function setRowActiveLocal(row, active){
    if (!row) return;
    if ('estatus' in row){ row.estatus = active ? 'activo' : 'inactivo'; }
    else if ('activo' in row){ row.activo = !!active; }
    else { row.estatus = active ? 'activo' : 'inactivo'; }
  }
  async function togglePax(id, toActive, btn){
    try{
      if (!id) return; if (btn) btn.disabled=true;
      const res=await fetch(`${API_BASE}/api/actividades-pax/${id}/estatus`,{
        method:'PATCH', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ activo: !!toActive })
      });
      const j = await res.json().catch(()=>null);

      if (!res.ok){
        let msg=T('toggle_err');
        if (j && (j.error||j.message)) msg=j.error||j.message;
        showPopupText(msg, { /* usa estilo default con badge */ });
        return;
      }

      const idx = paxData.findIndex(a=> String(a.id)===String(id));
      if (idx!==-1){
        const row=paxData[idx];
        setRowActiveLocal(row, !!toActive);
        if (j?.data?.updated_at) row.updated_at=j.data.updated_at;
      }

      showPopupText(toActive?T('toggle_on_ok'):T('toggle_off_ok'));
      renderPaxTable();
    }catch(err){
      console.error('‚ùå togglePax:', err);
      showPopupText(T('toggle_err'));
    }finally{
      if (btn) btn.disabled=false;
    }
  }

  /* ===== B√öSQUEDA ===== */
  if (btnSearchPax){ btnSearchPax.addEventListener('click', ()=>{ currentSearch=(txtSearchPax.value||'').trim(); applyFilterAndRender(); }); }
  if (btnClearSearchPax){ btnClearSearchPax.addEventListener('click', ()=>{ if (txtSearchPax) txtSearchPax.value=''; currentSearch=''; applyFilterAndRender(); }); }
  if (txtSearchPax){ txtSearchPax.addEventListener('keydown', e=>{ if (e.key==='Enter'){ e.preventDefault(); if (btnSearchPax) btnSearchPax.click(); } }); }

  /* ===== MODAL (editar/crear) ===== */
  const modalOverlay=$id('modal-overlay'), modalActBox=$id('modal-activity');
  const modalActTitle=$id('modal-act-title'), modalActSub=$id('modal-act-sub');

  const inpCodigo=$id('ma-codigo'),
        selMoneda=$id('ma-moneda'),
        inpNombre=$id('ma-nombre'),
        inpDurEs=$id('ma-dur-es'),
        inpDurEn=$id('ma-dur-en'),
        inpCapEs=$id('ma-cap-es'),
        inpCapacidad=$id('ma-capacidad'),
        inpPrecio=$id('ma-precio'),
        inpPrecioNormal=$id('ma-precio-normal'),
        inpPrecioOPC=$id('ma-precio-opc'),
        selProveedor=$id('ma-proveedor');

  /* ‚Äî‚Äî GRUPO ‚Äî‚Äî */
  const rowGrupoTitle   = $id('row-grupo-title');
  const chkGrupoExist   = $id('chk-grupo-existente');
  const chkGrupoNuevo   = $id('chk-grupo-nuevo');
  const hintGrupo       = $id('hint-grupo');
  const hintLock        = $id('hint-lock');
  const hintLockText    = $id('hint-lock-text');
  const rowSelectGrupo  = $id('row-select-grupo');
  const selGrupo        = $id('ma-grupo-select');
  const lblGrupoTitle   = $id('lbl-grupo-title');
  const lblGrupoExist   = $id('lbl-grupo-existente');
  const lblGrupoNuevo   = $id('lbl-grupo-nuevo');
  const lblGrupoSelect  = $id('lbl-ma-grupo');

  const btnActCancel=$id('btn-act-cancel'), btnActSave=$id('btn-act-save'), btnAdd=$id('btn-add-pax');
  let editingId=null;

  let pax_modalModeNew=false;
  let pax_groupMode='none'; // 'none' | 'existente' | 'nuevo'
  let pax_forceLock=false;
  let pax_lastGroup=null;

  function applyModalTexts(isNew){
    if (modalActTitle) modalActTitle.textContent = isNew ? T('modal_title_new') : T('modal_title_edit');
    if (modalActSub)   modalActSub.textContent   = T('modal_subtitle');

    $id('lbl-ma-codigo').textContent        = T('ma_code');
    $id('lbl-ma-moneda').textContent        = T('ma_currency');
    $id('lbl-ma-nombre').textContent        = T('ma_activity');

    $id('lbl-ma-dur-es').textContent        = T('dur_es_label');
    $id('lbl-ma-dur-en').textContent        = T('dur_en_label');

    $id('lbl-ma-cap-es').textContent        = T('cap_es_label');
    $id('lbl-ma-capacidad').textContent     = T('cap_en_label');

    $id('lbl-ma-precio').textContent        = T('ma_price');
    $id('lbl-ma-precio-normal').textContent = T('ma_price_reg');
    $id('lbl-ma-precio-opc').textContent    = T('ma_price_opc');
    $id('lbl-ma-proveedor').textContent     = T('ma_supplier');

    if (lblGrupoTitle)  lblGrupoTitle.textContent = T('group_label');
    if (lblGrupoExist)  lblGrupoExist.textContent = T('grp_add_existing');
    if (lblGrupoNuevo)  lblGrupoNuevo.textContent = T('grp_create_new');
    if (lblGrupoSelect) lblGrupoSelect.textContent= T('grp_select_label');
    if (hintGrupo)      hintGrupo.textContent     = T('grp_choose_one');

    $id('lbl-btn-act-cancel').textContent   = T('btn_cancel');
    $id('lbl-btn-act-save').textContent     = T('btn_save');
  }

  if (selMoneda){ selMoneda.innerHTML = '<option value="USD">USD</option>'; selMoneda.value='USD'; selMoneda.disabled=true; }

  async function cargarProveedores(seleccionActual, isNew){
    try{
      if (!selProveedor) return; selProveedor.innerHTML='';
      if (isNew){
        const ph=document.createElement('option'); ph.value=''; ph.textContent=(__LANG==='es'?'Selecciona una opci√≥n':'Select an option'); ph.disabled=true; ph.selected=true; selProveedor.appendChild(ph);
      }
      const res=await fetch(`${API_BASE}/api/actividades/listar-partners`);
      if (!res.ok) throw new Error('HTTP '+res.status);
      const j=await res.json(); const list=Array.isArray(j.data)?j.data:[];      
      if (!isNew && seleccionActual && !list.some(p => (p.nombre||p.company||'').trim().toLowerCase()===String(seleccionActual).trim().toLowerCase())){
        const opt=document.createElement('option'); opt.value=seleccionActual; opt.textContent=seleccionActual; selProveedor.appendChild(opt);
      }
      for (const p of list){
        const nombre=(p.nombre||p.company||'').trim(); if (!nombre) continue;
        const opt=document.createElement('option'); opt.value=nombre; opt.textContent=nombre; selProveedor.appendChild(opt);
      }
      if (!isNew && seleccionActual){ selProveedor.value=seleccionActual; }
    }catch(err){
      console.error('‚ö†Ô∏è cargarProveedores:', err);
      selProveedor.innerHTML='';
      const opt=document.createElement('option'); opt.value=seleccionActual||''; opt.textContent=seleccionActual||''; selProveedor.appendChild(opt);
      selProveedor.value=seleccionActual||'';
    }
  }

  /* ======== GRUPO: helpers ======== */
  async function paxFillGrupoSelect(preselectId){
    if (!selGrupo) return;
    selGrupo.innerHTML='';
    const ph=document.createElement('option');
    ph.value=''; ph.textContent=(__LANG==='es'?'Selecciona una opci√≥n':'Select an option');
    ph.disabled=true; ph.selected=true; selGrupo.appendChild(ph);

    const map = new Map();
    for (const r of paxData){
      const gid = getGrupo(r);
      if (gid==null) continue;
      if (!map.has(gid)){
        map.set(gid, {
          id: gid,
          nombre: r.actividad || `Grupo ${gid}`,
          proveedor: r.proveedor || r.partner || ''
        });
      }
    }

    if (map.size===0){
      try{
        const res=await fetch(`${API_BASE}/api/actividades-pax/listar-actividades`);
        if (res.ok){
          const j=await res.json();
          const list=Array.isArray(j.data)?j.data:[];
          for (const r of list){
            const gid=getGrupo(r);
            if (gid==null) continue;
            if (!map.has(gid)){
              map.set(gid,{ id:gid, nombre:r.actividad||`Grupo ${gid}`, proveedor:r.proveedor||r.partner||'' });
            }
          }
        }
      }catch(_){}
    }

    const list = Array.from(map.values()).sort((a,b)=> String(a.nombre).localeCompare(String(b.nombre)));
    for (const g of list){
      const opt=document.createElement('option');
      opt.value = g.id;
      opt.textContent = `${g.nombre} (ID ${g.id})`;
      opt.dataset.proveedor = g.proveedor || '';
      selGrupo.appendChild(opt);
    }

    if (preselectId!=null){
      selGrupo.value = String(preselectId);
    }
  }

  function paxUpdateLockBadge(){
    if (!hintLock || !hintLockText) return;
    const show = pax_forceLock && pax_groupMode==='existente';
    hintLock.classList.toggle('show', !!show);
    if (show){
      const idText = pax_lastGroup?.id != null ? ` ¬∑ ${T('grp_select_label')}: ID ${pax_lastGroup.id}` : '';
      hintLockText.textContent = T('grp_locked') + idText;
    }
  }

  function paxAplicarProveedorDeGrupo(){
    if (!pax_modalModeNew) return;
    if (pax_groupMode!=='existente') { if (selProveedor){ selProveedor.disabled=false; } return; }
    const opt= selGrupo?.options?.[selGrupo.selectedIndex];
    const prov = opt?.dataset?.veedor || opt?.dataset?.proveedor || '';
    if (!selProveedor) return;
    if (prov && !Array.from(selProveedor.options).some(o=> String(o.value).trim().toLowerCase()===String(prov).trim().toLowerCase())){
      const extra=document.createElement('option'); extra.value=prov; extra.textContent=prov; selProveedor.appendChild(extra);
    }
    if (prov){ selProveedor.value = prov; }
    selProveedor.disabled = !!(pax_forceLock && prov);
  }

  function paxSetGroupMode(mode){
    pax_groupMode = mode;
    if (chkGrupoExist) chkGrupoExist.checked = (mode==='existente');
    if (chkGrupoNuevo) chkGrupoNuevo.checked = (mode==='nuevo');

    if (rowSelectGrupo) rowSelectGrupo.style.display = (mode==='existente') ? 'block' : 'none';
    if (selProveedor)  selProveedor.disabled = false;

    if (mode==='existente'){
      paxAplicarProveedorDeGrupo();
    }
    paxUpdateLockBadge();
  }

  if (chkGrupoExist){
    chkGrupoExist.addEventListener('change', async ()=>{
      pax_forceLock=false;
      paxSetGroupMode(chkGrupoExist.checked ? 'existente' : (chkGrupoNuevo?.checked ? 'nuevo':'none'));
      if (chkGrupoExist.checked){
        await paxFillGrupoSelect('');
        if (selGrupo) selGrupo.disabled=false;
        paxAplicarProveedorDeGrupo();
      }
    });
  }
  if (chkGrupoNuevo){
    chkGrupoNuevo.addEventListener('change', ()=>{
      pax_forceLock=false;
      paxSetGroupMode(chkGrupoNuevo.checked ? 'nuevo' : (chkGrupoExist?.checked ? 'existente':'none'));
      if (selGrupo) selGrupo.disabled=false;
      paxAplicarProveedorDeGrupo();
    });
  }
  if (selGrupo){
    selGrupo.addEventListener('change', paxAplicarProveedorDeGrupo);
  }

  function openPaxModal(row){
    const isNew = !row || row.id==null; editingId = isNew ? null : row.id;
    applyModalTexts(isNew);

    pax_modalModeNew = isNew;
    pax_forceLock = false;
    pax_lastGroup = null;

    if (rowGrupoTitle) rowGrupoTitle.style.display = isNew ? 'block' : 'none';
    if (rowSelectGrupo) rowSelectGrupo.style.display = 'none';
    paxSetGroupMode('none');

    if (inpCodigo)        inpCodigo.value        = isNew ? '' : (row.codigo ?? '');
    if (inpNombre)        inpNombre.value        = isNew ? '' : (row.actividad ?? '');

    if (inpDurEs)         inpDurEs.value         = isNew ? '' : (row.duracion_es ?? '');
    if (inpDurEn)         inpDurEn.value         = isNew ? '' : (row.duracion ?? '');

    if (inpCapEs)         inpCapEs.value         = isNew ? '' : (row.capacidad_es ?? '');
    if (inpCapacidad)     inpCapacidad.value     = isNew ? '' : (row.capacidad ?? '');

    if (inpPrecio)        inpPrecio.value        = isNew ? '' : (row.precio ?? '');
    if (inpPrecioNormal)  inpPrecioNormal.value  = isNew ? '' : (row.precio_normal ?? '');
    if (inpPrecioOPC)     inpPrecioOPC.value     = isNew ? '' : (row.precioopc ?? row.precio_opc ?? '');

    if (selMoneda){ selMoneda.value='USD'; selMoneda.disabled=true; }

    cargarProveedores(isNew ? '' : (row.proveedor || row.partner || ''), isNew);

    if (isNew){
      paxFillGrupoSelect('');
    }

    modalOverlay.style.display='block';
    modalOverlay.setAttribute('aria-hidden','false');
    modalActBox.setAttribute('aria-hidden','false');
    if (inpCodigo) inpCodigo.focus();
  }
  function closePaxModal(){
    modalOverlay.setAttribute('aria-hidden','true');
    modalActBox.setAttribute('aria-hidden','true');
    modalOverlay.style.display='none';
    editingId=null;
  }
  if (btnActCancel) btnActCancel.addEventListener('click', closePaxModal);
  if (modalOverlay) modalOverlay.addEventListener('click', closePaxModal);
  if (document.getElementById('btn-add-pax')) document.getElementById('btn-add-pax').addEventListener('click', ()=> openPaxModal(null));

  function buildUpdateUrl(id){ return `${API_BASE}/api/actividades-pax/${id}`; }
  function buildCreateUrl(){ return `${API_BASE}/api/actividades-pax`; }

  function paxBuildGrupoFields(){
    if (!pax_modalModeNew) return { actividad_id: null, groupMode: 'existente' };
    if (pax_groupMode==='existente'){
      const gid = selGrupo?.value ? Number(selGrupo.value) : null;
      return { actividad_id: Number.isFinite(gid)?gid:null, groupMode:'existente' };
    }
    if (pax_groupMode==='nuevo'){ return { actividad_id: null, groupMode:'nuevo' }; }
    return { actividad_id: null, groupMode:'none' };
  }

  async function savePax(){
    const { actividad_id, groupMode } = paxBuildGrupoFields();

    const payload={
      codigo:        textOrNull(inpCodigo?.value),
      actividad:     textOrNull(inpNombre?.value),
      moneda:        'USD',

      duracion_es:   textOrNull(inpDurEs?.value),
      duracion:      textOrNull(inpDurEn?.value),
      capacidad_es:  textOrNull(inpCapEs?.value),
      capacidad:     textOrNull(inpCapacidad?.value), // TEXTO

      precio:        numOrNull(inpPrecio?.value),
      precio_normal: numOrNull(inpPrecioNormal?.value),
      precioopc:     numOrNull(inpPrecioOPC?.value),

      proveedor:     textOrNull(selProveedor?.value),

      actividad_id:  actividad_id,
      groupMode:     groupMode
    };

    if (!payload.codigo || !payload.actividad || !payload.moneda){
      showPopupText(T('save_err')); return;
    }
    if (pax_modalModeNew && groupMode==='existente' && !payload.actividad_id){
      showPopupText(T('grp_must_select')); return;
    }

    const isNew = (editingId==null);
    const btn = $id('btn-act-save'); if (btn) btn.disabled=true;
    try{
      let res, msgOk;
      if (!isNew){
        res=await fetch(buildUpdateUrl(editingId),{
          method:'PUT',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify(payload)
        });
        msgOk=T('saved_ok');
      }else{
        res=await fetch(buildCreateUrl(),{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify(payload)
        });
        msgOk=T('created_ok');
      }

      const j = await res.json().catch(()=>null);

      /* === VALIDACI√ìN EXACTA (sin chapita, t√≠tulo "Error", y cat√°logos exactos) === */
      if (!res.ok){
        let msg = T('save_err');
        if (j){
          const fields  = j.fields || j.field || {};
          const hasCode = !!fields.codigo;
          const hasDur  = !!(fields.duracion_es || fields.duracion);

          // Lista espec√≠fica de cat√°logos si viene del back
          const catNames = buildCatalogNamesFrom409(j);

          // Respaldo por m√≥dulo si no hay lista
          let modKey = resolveModuleKeyFromServer(j);
          let modLbl = moduleLabelForLang(modKey || 'pax');

          if (res.status === 409 && (hasCode || hasDur)){
            if (hasCode){
              msg = T('err_code_in', catNames || modLbl);
            } else if (hasDur){
              msg = T('err_duration_in', catNames || modLbl);
            }
          } else if (j.error || j.message){
            msg = j.error || j.message;
          } else if (res.status === 409){
            msg = T('save_err_validation');
          }
        }

        // Popup SIN badge y con t√≠tulo "Error" (igual Tiempo)
        showPopupText(msg, { title: T('err_title'), badge: false });
        return;
      }

      const createdId = j?.data?.id ?? j?.id ?? null;

      closePaxModal(); showPopupText(msgOk); // aqu√≠ s√≠ usa el estilo normal con badge
      await loadPax();
      if (!isNew && editingId){ highlightId=editingId; }
      else if (createdId){ highlightId=createdId; }
      renderPaxTable();
    }catch(err){
      console.error('‚ùå savePax:', err);
      showPopupText(T('save_err'), { title:T('err_title'), badge:false });
    }finally{
      if (btn) btn.disabled=false;
    }
  }
  if ($id('btn-act-save')) $id('btn-act-save').addEventListener('click', savePax);

  /* ===== TEXTOS / LANG ===== */
  function applyPaxUiTexts(){
    const mapTh = {
      'th-code-pax':'pax_th_code','th-activity-pax':'pax_th_activity','th-capacity-pax':'pax_th_capacity','th-price-pax':'pax_th_price',
      'th-currency-pax':'pax_th_currency','th-supplier-pax':'pax_th_supplier','th-status-pax':'pax_th_status','th-created-pax':'pax_th_created',
      'th-updated-pax':'pax_th_updated','th-actions-pax':'pax_th_actions'
    };
    Object.entries(mapTh).forEach(([id,key])=>{ const el=$id(id); if (el) el.textContent=T(key); });
    const lblSearch=$id('lbl-search-pax'); if (lblSearch) lblSearch.textContent=T('pax_search_label');
    const txtSearch=$id('txt-search-pax'); if (txtSearch) txtSearch.placeholder=T('pax_search_ph');
    const b1=$id('lbl-btn-search-pax'); if (b1) b1.textContent=T('pax_btn_search');
    const b2=$id('lbl-btn-clear-pax'); if (b2) b2.textContent=T('pax_btn_clear');
    const b3=$id('lbl-btn-add-pax'); if (b3) b3.textContent=T('pax_btn_add');
    const pe=$id('popup-edit-text'); if (pe) pe.textContent=T('popup_btn_edit');
    const pc=$id('popup-close-text'); if (pc) pc.textContent=T('popup_btn_ok');
  }
  function applyTexts(){
    const sb=$id('sidebar-title'); if (sb) sb.textContent=T('sidebar_title');
    const m1=document.querySelector('#menu button[data-sec="tc"]');
    const m2=document.querySelector('#menu button[data-sec="usr-trn"]');
    const m3=document.querySelector('#menu button[data-sec="usr-act"]');
    const m4=document.querySelector('#menu button[data-sec="acts"]');
    const m5=document.querySelector('#menu button[data-sec="partners"]');
    if (m1) m1.textContent=T('m_tc'); if (m2) m2.textContent=T('m_usr_trn'); if (m3) m3.textContent=T('m_usr_act'); if (m4) m4.textContent=T('m_acts'); if (m5) m5.textContent=T('m_partners');
    const btnRep=$id('btn-reportes'); if (btnRep) btnRep.textContent=T('m_reports');
    const btnErr=$id('btn-errores'); if (btnErr) btnErr.textContent=T('m_errors');
    const logoutBtn=$id('logout'); if (logoutBtn) logoutBtn.textContent=T('logout');
    const db=$id('date-badge'); if (db) db.textContent=T('date_badge', new Date());
    const hTitle=$id('h3-title'); const pIntro=$id('p-intro'); if (hTitle) hTitle.textContent=T('title'); if (pIntro) pIntro.textContent=T('intro');
    const tabTours=$id('tab-tours-label'), tabTime=$id('tab-tiempo-label'), tabPax=$id('tab-pax-label'), tabCombo=$id('tab-combo-label');
    if (tabTours) tabTours.textContent=T('tab_tours'); if (tabTime) tabTime.textContent=T('tab_tiempo'); if (tabPax) tabPax.textContent=T('tab_pax'); if (tabCombo) tabCombo.textContent=T('tab_combo');
    applyPaxUiTexts();
  }
  function setLang(lang){
    const newLang=mapLang(lang); if (newLang===__LANG) return; __LANG=newLang;
    applyTexts(); renderPaxTable();
  }

  /* ===== MENSAJES PADRE ===== */
  window.addEventListener('message',(e)=>{
    const d=e.data||{};
    if (d.type==='CTS_LANG' && d.lang){ setLang(d.lang); }
    if (d.type==='MAIL_ERROR_COUNT' && d.total!==undefined){ const n=Number(d.total); __MAIL_ERRORS=Number.isFinite(n)&&n>0?n:0; updateErrorsButtonLabel(); }
    const nombre=d.supervisor||d.administrador||d.admin||d.usuario||d.nombre||d.userName; if (nombre){ setWelcome(nombre); }
    if (d.type==='ACTIVIDADES_IFRAME_NAV_SET' && d.iframe){
      const entry=Object.entries({tours:'iframeTours',tiempo:'iframeTiempo',pax:'iframePax',combo:'iframeCombo'})
        .find(([k,v])=> v===d.iframe);
      if (entry){ const tabId=entry[0]; setActiveTab(tabId,true); }
    }
  });
  function requestHandshake(){
    try{ window.parent.postMessage({ type:'CTS_LANG_REQ' }, '*'); }catch(_){}
    try{ window.parent.postMessage({ type:'PARAMS_REQ_SESSION' }, '*'); }catch(_){}
    try{ window.parent.postMessage({ type:'MAIL_ERROR_COUNT_REQ' }, '*'); }catch(_){}
  }

  // INIT
  (function init(){
    document.getElementById('sidebar').classList.add('sidebar-oculto');
    setLang('en');
    applyTexts();
    setActiveTab('pax', true);
    requestHandshake();
    currentPage = 1;
    loadPax();
  })();
</script>
</body>
</html>